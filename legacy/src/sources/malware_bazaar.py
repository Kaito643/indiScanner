import requests
from typing import Generator, Dict
from ..source_base import SourceBase
from loguru import logger

class MalwareBazaar(SourceBase):
    API_URL = "https://mb-api.abuse.ch/api/v1/"

    def __init__(self, api_key: str):
        super().__init__(api_key)
        self.name = "MalwareBazaar"

    def search(self, group_name: str, limit: int = 1000) -> Generator[Dict, None, None]:
        logger.info(f"Searching MalwareBazaar for tag: {group_name}")
        payload = {
            "query": "get_taginfo",
            "tag": group_name,
            "limit": limit
        }
        
        headers = {
            "User-Agent": "RansomwareDownloader/1.0"
        }
        if self.api_key:
            headers["Auth-Key"] = self.api_key
        
        try:
            # Using get_taginfo as it supports limit up to 1000 and is intended for this
            response = requests.post(self.API_URL, data=payload, headers=headers, timeout=30)
            response.raise_for_status()
            data = response.json()

            if data.get("query_status") != "ok":
                logger.warning(f"MalwareBazaar query status: {data.get('query_status')}")
                return

            for sample in data.get("data", []):
                yield {
                    "hash": sample.get("sha256_hash"),
                    "filename": sample.get("file_name", "unknown.bin"),
                    "first_seen": sample.get("first_seen"),
                    "tags": sample.get("tags", []),
                    "file_type": sample.get("file_type"),
                    "signature": sample.get("signature")
                }

        except Exception as e:
            if "401" in str(e):
                logger.error(f"MalwareBazaar 401 Unauthorized. Please check your API_KEY in .env.")
            else:
                logger.error(f"Error searching MalwareBazaar: {e}")

    def download(self, file_hash: str) -> bytes:
        logger.info(f"Downloading {file_hash} from MalwareBazaar")
        payload = {
            "query": "get_file",
            "sha256_hash": file_hash,
        }
        headers = {}
        if self.api_key:
            headers["Auth-Key"] = self.api_key

        try:
            response = requests.post(self.API_URL, data=payload, headers=headers, timeout=60)
            
            if "file_not_found" in response.text:
                logger.warning(f"File not found in MalwareBazaar: {file_hash}")
                return None
                
            response.raise_for_status()
            return response.content
        except Exception as e:
            logger.error(f"Error downloading from MalwareBazaar: {e}")
            return None
